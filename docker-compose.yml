# ==============================================================================
# Docker Compose 설정 파일
# ==============================================================================
#
# Docker Compose란?
#   여러 개의 Docker 컨테이너를 한 번에 관리하는 도구입니다.
#   이 파일 하나로 서버, DB 등을 한 번에 실행/중지할 수 있습니다.
#
# 주요 명령어:
#   docker-compose up -d      # 모든 서비스 백그라운드 실행
#   docker-compose up --build # 이미지 다시 빌드 후 실행
#   docker-compose down       # 모든 서비스 중지
#   docker-compose logs -f    # 로그 실시간 확인
#   docker-compose ps         # 실행 중인 서비스 목록
#
# 실행 후 접속:
#   - API 서버: http://localhost:8000
#   - API 문서: http://localhost:8000/docs
#
# ==============================================================================

# Docker Compose 파일 형식 버전
version: "3.8"

# =============================================================================
# 서비스 정의
# =============================================================================
# services: 실행할 컨테이너들을 정의합니다.
# 각 서비스는 하나의 컨테이너가 됩니다.
#
services:
  # ===========================================================================
  # News API 서버
  # ===========================================================================
  news-api:
    # -------------------------------------------------------------------------
    # 빌드 설정
    # -------------------------------------------------------------------------
    # build: Docker 이미지를 어떻게 만들지 설정
    #   context: Dockerfile이 있는 폴더 (현재 폴더)
    #   dockerfile: 사용할 Dockerfile 이름
    #
    build:
      context: .
      dockerfile: Dockerfile

    # -------------------------------------------------------------------------
    # 컨테이너 이름
    # -------------------------------------------------------------------------
    # 이 이름으로 컨테이너를 관리할 수 있습니다.
    # 예: docker logs news-api
    #
    container_name: news-api

    # -------------------------------------------------------------------------
    # 포트 매핑
    # -------------------------------------------------------------------------
    # 형식: "호스트포트:컨테이너포트"
    #
    # "8000:8000" 의미:
    #   - 내 컴퓨터의 8000번 포트로 접속하면
    #   - 컨테이너의 8000번 포트로 연결됨
    #
    # 예시:
    #   "80:8000" → localhost:80 으로 접속 가능
    #
    ports:
      - "8000:8000"

    # -------------------------------------------------------------------------
    # 환경 변수
    # -------------------------------------------------------------------------
    # 컨테이너 안에서 사용할 환경 변수를 설정합니다.
    # app/config.py에서 이 값들을 읽어갑니다.
    #
    # 주의: 실제 운영 환경에서는 비밀번호 등을 직접 적지 마세요!
    #          대신 .env 파일이나 시크릿 관리 도구를 사용하세요.
    #
    environment:
      # 데이터베이스 연결 정보
      # SQLite 사용 (개발용)
      # 실제 서버 DB 사용 시 아래 형식으로 변경:
      # - DATABASE_URL=postgresql+asyncpg://user:password@host:5432/dbname
      - DATABASE_URL=sqlite+aiosqlite:///./data/news.db

      # 디버그 모드 (프로덕션에서는 false)
      - DEBUG=false

      # CORS 허용 출처
      # Flutter 앱 등에서 API에 접근할 수 있도록 허용
      - CORS_ORIGINS=http://localhost:3000,http://localhost:51151,http://localhost:*

    # -------------------------------------------------------------------------
    # 볼륨 마운트
    # -------------------------------------------------------------------------
    # 볼륨(Volume): 컨테이너와 호스트 간에 파일을 공유하는 방법
    #
    # 형식: "호스트경로:컨테이너경로[:옵션]"
    #
    # 왜 볼륨을 사용하나요?
    #   - 컨테이너를 삭제해도 데이터가 유지됨
    #   - 호스트에서 파일을 직접 수정 가능
    #
    # :ro = read-only (읽기 전용)
    #
    volumes:
      # DB 파일 저장 (컨테이너 삭제해도 데이터 유지)
      - ./data:/app/data

      # App의 CSV 파일을 컨테이너에서 읽기 (초기화용)
      - ../App/lib/dummy_data.csv:/app/data/dummy_data.csv:ro

    # -------------------------------------------------------------------------
    # 재시작 정책
    # -------------------------------------------------------------------------
    # unless-stopped: 수동으로 중지하지 않으면 항상 재시작
    #
    # 다른 옵션:
    #   - no: 재시작 안 함
    #   - always: 항상 재시작 (수동 중지해도)
    #   - on-failure: 에러로 종료됐을 때만 재시작
    #
    restart: unless-stopped

    # -------------------------------------------------------------------------
    # 네트워크 설정
    # -------------------------------------------------------------------------
    # 같은 네트워크에 있는 컨테이너끼리 통신 가능
    # 예: 다른 서비스에서 news-api:8000 으로 접근 가능
    #
    networks:
      - capstone-network

# =============================================================================
# 네트워크 정의
# =============================================================================
# Docker 네트워크를 정의합니다.
# 같은 네트워크의 컨테이너끼리는 서비스 이름으로 통신 가능합니다.
#
networks:
  capstone-network:
    driver: bridge # 기본 네트워크 드라이버

# =============================================================================
# 프로덕션 환경 설정 (PostgreSQL 사용 시)
# =============================================================================
#
# 실제 서비스 운영 시에는 SQLite 대신 PostgreSQL을 사용하세요.
# 아래 주석을 해제하고 news-api의 DATABASE_URL을 변경하면 됩니다.
#
# services:
#   news-api:
#     environment:
#       # PostgreSQL 연결 정보
#       - DATABASE_URL=postgresql+asyncpg://news_user:news_password@postgres:5432/news_db
#     depends_on:
#       # DB가 준비된 후에 API 서버 시작
#       postgres:
#         condition: service_healthy
#
#   # PostgreSQL 데이터베이스
#   postgres:
#     image: postgres:15-alpine  # PostgreSQL 15 버전 (경량)
#     container_name: news-db
#     environment:
#       POSTGRES_USER: news_user        # DB 사용자명
#       POSTGRES_PASSWORD: news_password  # DB 비밀번호
#       POSTGRES_DB: news_db            # DB 이름
#     volumes:
#       # DB 데이터 영속화 (컨테이너 삭제해도 데이터 유지)
#       - postgres_data:/var/lib/postgresql/data
#     ports:
#       - "5432:5432"  # PostgreSQL 기본 포트
#     restart: unless-stopped
#     healthcheck:
#       # DB 준비 상태 확인
#       test: ["CMD-SHELL", "pg_isready -U news_user -d news_db"]
#       interval: 10s
#       timeout: 5s
#       retries: 5
#     networks:
#       - capstone-network
#
# volumes:
#   postgres_data:  # DB 데이터 저장용 볼륨
