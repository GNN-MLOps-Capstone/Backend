#!/bin/bash
# ==============================================================================
# 컨테이너 시작 스크립트 (entrypoint.sh)
# ==============================================================================
#
# 이 스크립트는 Docker 컨테이너가 시작될 때 가장 먼저 실행됩니다.
#
# 역할:
#   1. 필요한 경우 DB 초기화 (CSV -> DB)
#   2. API 서버(uvicorn) 시작
#
# 왜 별도 스크립트가 필요한가요?
#   - 컨테이너 시작 전에 준비 작업 수행
#   - 조건에 따라 다른 동작 가능
#   - 여러 명령어를 순차 실행
#
# ==============================================================================

# -----------------------------------------------------------------------------
# 안전 모드 설정
# -----------------------------------------------------------------------------
# set -e: 명령어가 실패하면 스크립트 즉시 종료
# 이렇게 하면 에러가 발생했을 때 빨리 알 수 있습니다.
#
set -e

# -----------------------------------------------------------------------------
# 시작 메시지
# -----------------------------------------------------------------------------
echo "Starting News API..."

# -----------------------------------------------------------------------------
# DB 초기화 (조건부)
# -----------------------------------------------------------------------------
# 조건:
#   1. CSV 파일이 존재하고 (/app/data/dummy_data.csv)
#   2. DB 파일이 없으면 (/app/data/news.db)
#   -> DB 초기화 스크립트 실행
#
# 이미 DB가 있으면 초기화를 건너뜁니다.
#    (데이터 덮어쓰기 방지)
#
# -f: 파일이 존재하는지 확인
# !: 부정 (존재하지 않으면)
# &&: 앞의 조건이 참이면 뒤의 명령 실행
#
if [ -f "/app/data/dummy_data.csv" ] && [ ! -f "/app/data/news.db" ]; then
    echo "Initializing database from CSV..."
    python scripts/init_db.py --csv-path /app/data/dummy_data.csv
fi

# -----------------------------------------------------------------------------
# 서버 시작
# -----------------------------------------------------------------------------
# exec: 현재 프로세스를 새 명령으로 대체
#
# 왜 exec를 사용하나요?
#   - exec 없이 실행하면 bash가 부모 프로세스로 남음
#   - exec로 실행하면 uvicorn이 메인 프로세스가 됨
#   - Docker의 SIGTERM 신호가 uvicorn에 직접 전달됨
#   - 컨테이너가 정상적으로 종료됨
#
# uvicorn 옵션:
#   --host 0.0.0.0: 모든 IP에서 접근 허용
#   --port 8000: 8000번 포트 사용
#
exec uvicorn app.main:app --host 0.0.0.0 --port 8000
