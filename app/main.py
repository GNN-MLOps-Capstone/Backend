"""
==============================================================================
FastAPI 메인 애플리케이션 (main.py)
==============================================================================

이 파일은 서버의 시작점(Entry Point)입니다.
서버를 실행하면 이 파일이 가장 먼저 실행됩니다.

주요 역할:
    1. FastAPI 앱 생성
    2. CORS 설정 (다른 도메인에서의 접근 허용)
    3. 라우터 연결 (API 엔드포인트 등록)
    4. 서버 시작/종료 시 실행할 작업 정의

실행 방법:
    # 방법 1: uvicorn 직접 실행
    uvicorn app.main:app --reload --port 8000
    
    # 방법 2: Python 모듈로 실행
    python -m app.main

실행 후 접속:
    - API 서버: http://localhost:8000
    - API 문서 (Swagger): http://localhost:8000/docs
    - API 문서 (ReDoc): http://localhost:8000/redoc

==============================================================================
"""

from contextlib import asynccontextmanager  # 비동기 컨텍스트 매니저
from fastapi import FastAPI  # 웹 프레임워크
from fastapi.middleware.cors import CORSMiddleware  # CORS 미들웨어

from app.config import get_settings  # 설정 가져오기
from app.database import init_db  # DB 초기화 함수
from app.routers import news  # 뉴스 API 라우터
from app.routers import stocks  # 주식 API 라우터

# 설정 객체 가져오기
settings = get_settings()


# =============================================================================
# 애플리케이션 생명주기 관리
# =============================================================================
#
# 서버가 시작될 때와 종료될 때 실행할 작업을 정의합니다.
#
# @asynccontextmanager: 비동기 컨텍스트 매니저 데코레이터
#   - yield 이전: 서버 시작 시 실행
#   - yield 이후: 서버 종료 시 실행
#
@asynccontextmanager
async def lifespan(app: FastAPI):
    """
    애플리케이션 생명주기 핸들러
    
    서버 시작/종료 시 실행되는 코드를 정의합니다.
    
    실행 순서:
        1. 서버 시작 요청
        2. yield 이전 코드 실행 (DB 초기화 등)
        3. 서버 운영 중...
        4. 서버 종료 요청
        5. yield 이후 코드 실행 (정리 작업)
    """
    # =========================================================================
    # 서버 시작 시 실행
    # =========================================================================
    print("Starting up News API server...")
    print(f"Database: {settings.database_url}")
    
    # DB 테이블 초기화 (없는 테이블만 생성)
    await init_db()
    print("Database initialized")
    
    # yield: 여기서 서버가 실행되고 요청을 처리함
    yield
    
    # =========================================================================
    # 서버 종료 시 실행
    # =========================================================================
    print("Shutting down...")


# =============================================================================
# FastAPI 앱 생성
# =============================================================================
#
# FastAPI 앱 인스턴스를 생성합니다.
# 이 객체가 모든 HTTP 요청을 처리합니다.
#
app = FastAPI(
    # -------------------------------------------------------------------------
    # API 문서 정보
    # -------------------------------------------------------------------------
    # /docs 페이지에 표시되는 정보입니다.
    #
    title="News API",  # API 제목
    description="실시간 뉴스 API 서버 - 캡스톤 프로젝트",  # 설명
    version="1.0.0",  # 버전
    
    # -------------------------------------------------------------------------
    # 생명주기 핸들러 연결
    # -------------------------------------------------------------------------
    lifespan=lifespan,
)


# =============================================================================
# CORS 설정
# =============================================================================
#
# CORS (Cross-Origin Resource Sharing)란?
#   웹 브라우저의 보안 정책으로, 다른 도메인에서 오는 요청을 기본적으로 차단합니다.
#   
#   예: Flutter 앱(localhost:51151)에서 API 서버(localhost:8000)로 요청하면
#       서로 다른 포트이므로 "다른 출처(Origin)"로 간주됩니다.
#
# CORS 미들웨어를 추가하면 특정 출처에서의 요청을 허용할 수 있습니다.
#
# 미들웨어(Middleware)란?
#   요청이 API에 도달하기 전에 먼저 처리하는 중간 계층입니다.
#   모든 요청에 대해 자동으로 실행됩니다.
#

# 설정에서 허용할 출처 목록 가져오기
# 예: "http://localhost:3000,http://localhost:51151" -> ["http://localhost:3000", "http://localhost:51151"]
origins = settings.cors_origins.split(",")

app.add_middleware(
    CORSMiddleware,
    # -------------------------------------------------------------------------
    # 허용할 출처 목록
    # -------------------------------------------------------------------------
    # ["*"]는 모든 출처 허용 (개발 중에는 편리하지만, 프로덕션에서는 보안상 위험)
    #
    allow_origins=origins + ["*"],  # 설정된 출처 + 모든 출처 (개발용)
    
    # -------------------------------------------------------------------------
    # 인증 정보 허용
    # -------------------------------------------------------------------------
    # True면 쿠키, 인증 헤더 등을 포함한 요청 허용
    #
    allow_credentials=True,
    
    # -------------------------------------------------------------------------
    # 허용할 HTTP 메서드
    # -------------------------------------------------------------------------
    # ["*"]는 모든 메서드 허용 (GET, POST, PUT, DELETE 등)
    #
    allow_methods=["*"],
    
    # -------------------------------------------------------------------------
    # 허용할 HTTP 헤더
    # -------------------------------------------------------------------------
    # ["*"]는 모든 헤더 허용
    #
    allow_headers=["*"],
)


# =============================================================================
# 라우터 연결
# =============================================================================
#
# 라우터(Router)란?
#   API 엔드포인트들을 그룹으로 묶은 것입니다.
#   
#   예: 뉴스 관련 API들 -> news 라우터
#       사용자 관련 API들 -> users 라우터
#
# include_router()로 라우터를 앱에 연결하면,
# 해당 라우터의 모든 엔드포인트가 활성화됩니다.
#
app.include_router(news.router)
app.include_router(stocks.router)


# =============================================================================
# 기본 엔드포인트
# =============================================================================

@app.get("/")
async def root():
    """
    루트 엔드포인트
    
    서버가 정상 작동하는지 확인하는 용도입니다.
    
    URL: GET http://localhost:8000/
    
    응답 예시:
    {
        "message": "Welcome to News API",
        "docs": "/docs",
        "redoc": "/redoc"
    }
    """
    return {
        "message": "Welcome to News API",
        "docs": "/docs",      # Swagger UI 문서 경로
        "redoc": "/redoc",    # ReDoc 문서 경로
    }


@app.get("/health")
async def health_check():
    """
    헬스 체크 엔드포인트
    
    서버가 살아있는지 확인하는 용도입니다.
    Docker, 로드밸런서, 모니터링 도구 등에서 사용합니다.
    
    URL: GET http://localhost:8000/health
    
    응답 예시:
    {
        "status": "healthy"
    }
    
    사용 예:
        - Docker HEALTHCHECK
        - Kubernetes liveness probe
        - 로드밸런서 health check
    """
    return {"status": "healthy"}


# =============================================================================
# 직접 실행 시 서버 시작
# =============================================================================
#
# 이 파일을 직접 실행하면 (python -m app.main)
# uvicorn 서버가 시작됩니다.
#
# __name__ == "__main__":
#   이 파일이 직접 실행될 때만 True
#   다른 파일에서 import될 때는 False
#
if __name__ == "__main__":
    import uvicorn  # ASGI 서버
    
    # uvicorn 서버 실행
    uvicorn.run(
        "app.main:app",      # 앱 위치 (파일:변수명)
        host=settings.host,  # 호스트 (0.0.0.0 = 모든 IP에서 접근 가능)
        port=settings.port,  # 포트 (기본 8000)
        reload=settings.debug,  # 코드 변경 시 자동 재시작 (개발용)
    )
